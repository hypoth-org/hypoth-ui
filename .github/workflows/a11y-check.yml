name: Accessibility Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: a11y-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  a11y:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies
        run: pnpm --filter @ds/wc... build

      - name: Run accessibility tests
        id: a11y-test
        run: |
          mkdir -p a11y-reports
          pnpm --filter @ds/wc test:a11y --reporter=json --reporter=default --outputFile=a11y-reports/results.json 2>&1 | tee a11y-reports/output.txt
        env:
          A11Y_SEVERITY: critical,serious

      - name: Generate a11y report summary
        if: always()
        run: |
          echo "## Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f a11y-reports/results.json ]; then
            TOTAL=$(jq '.numTotalTests // 0' a11y-reports/results.json 2>/dev/null || echo "0")
            PASSED=$(jq '.numPassedTests // 0' a11y-reports/results.json 2>/dev/null || echo "0")
            FAILED=$(jq '.numFailedTests // 0' a11y-reports/results.json 2>/dev/null || echo "0")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Severity Threshold**: Critical + Serious" >> $GITHUB_STEP_SUMMARY

      - name: Upload a11y report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: a11y-report-${{ github.sha }}
          path: a11y-reports/
          retention-days: 1825  # 5 years per FR-017a

      - name: Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## ❌ Accessibility Check Failed\n\n';
            body += 'This PR introduces accessibility violations that must be fixed before merging.\n\n';
            body += '### How to fix:\n';
            body += '1. Run `pnpm --filter @ds/wc test:a11y` locally to see detailed violations\n';
            body += '2. Review the remediation guidance in the test output\n';
            body += '3. Fix the violations and push your changes\n\n';
            body += '### Severity threshold\n';
            body += 'CI fails on **Critical** and **Serious** violations.\n\n';
            body += '---\n';
            body += '*For more information, see the [Accessibility Conformance documentation](/accessibility)*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
